# Portfolio Feature Notes
This file must be kept up to date by the LLM whenever this feature changes.

## Purpose
- Portfolio UI states (empty state + dashboard with holdings summary).
- Portfolio selection + creation UI for multi-portfolio support.
- Server helpers for holdings and portfolio summaries.

## Main entrypoints
- `src/features/portfolio/components/DashboardEmptyState.tsx`
- `src/features/portfolio/components/PortfolioDashboardSkeleton.tsx`
- `src/features/portfolio/components/PortfolioSwitcher.tsx`
- `src/features/portfolio/components/CreatePortfolioDialog.tsx`
- `src/features/portfolio/components/CreateFirstPortfolioAction.tsx`
- `src/features/portfolio/components/PortfolioMobileHeaderActions.tsx`
- `src/features/portfolio/dashboard/PortfolioDashboard.tsx`
- `src/features/portfolio/dashboard/PortfolioNetValueHero.tsx`
- `src/features/portfolio/dashboard/widgets/AllocationHoldingsWidget.tsx`
- `src/features/portfolio/dashboard/widgets/PortfolioValueOverTimeWidget.tsx`
- `src/features/portfolio/dashboard/widgets/PortfolioValueOverTimeChart.tsx`
- `src/features/portfolio/dashboard/widgets/PortfolioValueOverTimeHeader.tsx`
- `src/features/portfolio/dashboard/widgets/PortfolioSnapshotRebuildChartLoader.tsx`
- `src/features/portfolio/dashboard/widgets/PortfolioValueDailySummaryCard.tsx`
- `src/features/portfolio/dashboard/widgets/PortfolioPerformanceDailySummaryCard.tsx`
- `src/features/portfolio/dashboard/widgets/PortfolioTopMoversWidget.tsx`
- `src/features/portfolio/dashboard/widgets/PortfolioRecentTransactionsWidget.tsx`
- `src/features/portfolio/dashboard/widgets/top-movers-utils.ts`
- `src/features/portfolio/dashboard/lib/twr.ts`
- `src/features/portfolio/dashboard/lib/chart-helpers.ts`
- `src/features/portfolio/dashboard/lib/portfolio-value-over-time-view-model.ts`
- `src/features/portfolio/dashboard/lib/benchmark-config.ts`
- `src/features/portfolio/dashboard/lib/benchmark-performance.ts`
- `src/features/portfolio/server/list-portfolios.ts`
- `src/features/portfolio/server/create-portfolio.ts`
- `src/features/portfolio/server/get-portfolio-holdings.ts`
- `src/features/portfolio/server/custom-instruments/compound-annual-rate.ts`
- `src/features/portfolio/server/get-portfolio-average-buy-prices.ts`
- `src/features/portfolio/server/average-buy-price.ts`
- `src/features/portfolio/server/get-portfolio-summary.ts`
- `src/features/portfolio/server/valuation.ts`
- `src/features/portfolio/server/to-base-holding-day-change.ts`
- `src/features/portfolio/server/get-dashboard-benchmark-series.ts`
- `src/features/portfolio/server/benchmark-series-helpers.ts`
- `src/app/api/benchmarks/series/route.ts`
- `src/features/portfolio/server/snapshots/compute-portfolio-snapshot.ts`
- `src/features/portfolio/server/snapshots/get-portfolio-snapshot-rows.ts`
- `src/features/portfolio/server/snapshots/run-portfolio-snapshots-cron.ts`
- `src/features/portfolio/server/snapshots/bootstrap-portfolio-snapshot.ts`
- `src/features/portfolio/server/snapshots/rebuild-state.ts`
- `src/features/portfolio/server/snapshots/compute-portfolio-snapshot-range-helpers.ts`
- `src/features/portfolio/server/snapshots/range-market-data.ts`
- `src/features/portfolio/server/snapshots/range-market-data-cursor.ts`
- `src/features/portfolio/server/snapshots/rebuild-chunk-window.ts`
- `src/features/portfolio/server/snapshots/snapshot-rebuild-range-session.ts`
- `src/features/portfolio/server/snapshots/snapshot-rebuild-range-day.ts`
- `src/features/portfolio/server/snapshots/fetch-custom-holdings-admin-as-of.ts`
- `src/features/portfolio/server/snapshots/run-snapshot-rebuild.ts`
- `src/features/portfolio/server/snapshots/rebuild-route-service.ts`
- `src/app/api/portfolio-snapshots/rebuild/route.ts`
- `src/app/api/portfolio-snapshots/bootstrap/route.ts`
- `src/features/portfolio/dashboard/hooks/useSnapshotRebuild.ts`
- `src/features/portfolio/dashboard/hooks/use-snapshot-rebuild-events.ts`
- `src/features/portfolio/dashboard/hooks/use-snapshot-rebuild-state-polling.ts`
- `src/features/portfolio/dashboard/hooks/use-snapshot-rebuild-runner.ts`
- `src/features/portfolio/dashboard/hooks/snapshot-rebuild-polling.ts`
- `src/features/portfolio/lib/snapshot-rebuild-contract.ts`
- `src/features/portfolio/lib/snapshot-rebuild-events.ts`
- `src/features/portfolio/lib/create-portfolio-schema.ts`
- `src/features/portfolio/lib/portfolio-url.ts`
- `src/features/portfolio/lib/rebuild-progress.ts`

## Boundaries
- UI plus server helpers; valuation calculations live in `server/valuation.ts`.
- Snapshoty dzienne (PLN/USD/EUR) są liczone backendowo i używane do wykresu wartości, zainwestowanego kapitału i performance (TWR).
- Snapshoty zawierają przepływy: external cashflow (DEPOSIT/WITHDRAWAL) + implicit transfer (asset bez cash legs).
- TWR liczy zwrot dzienny: (V_D - CF_D - V_{D-1}) / V_{D-1}, z restartem serii przy brakach.
- W trybie wartości dla zakresów >1D renderujemy dwie linie: wartość portfela (smooth) + zainwestowany kapitał (step).
- Wykres performance pokazuje linię zwrotu skumulowanego (TWR) dla zakresów >1D.
- Tryby wykresu wartości/performance współdzielą layout widgetu (`portfolio-value-over-time-chart-layout.ts`): wspólna wysokość wykresu, wspólny empty-state i wspólne minimalne `min-height` karty.
- Ciężkie komponenty wykresów (`PortfolioComparisonChart`, `DailyReturnsLineChart`, `AllocationDonutChart`) są ładowane przez `next/dynamic` na poziomie całego komponentu (ssr: false) w widgetach portfolio, aby zmniejszyć koszt startowy bez łamania parsera dzieci Recharts.
- Dashboard ma jeden wspólny widget `Alokacja i pozycje` z przełącznikiem `Koło/Tabela` (domyślnie `Koło`), zamiast dwóch osobnych kart 50/50.
- Widok `Koło` renderuje donut jako pełną szerokość widgetu (bez stałej kolumny 220px), a legenda udziałów ma czytelniejsze kafelki z paskiem udziału.
- W trybie performance dla zakresów >1D bazowa linia to nominalny zwrot skumulowany, a porównania są opcjonalne (checkboxy): inflacja PL, S&P 500 (VOO), WIG20 (ETFBW20TR), mWIG40 (ETFBM40TR).
- Kontrolki porównań benchmarków w nagłówku wykresu są skonsolidowane do jednego popovera `Porównaj z...` (multi-select), aby zmniejszyć gęstość UI.
- Paleta linii porównań jest rozdzielona tak, aby nie mylić bazowej linii zwrotu z inflacją (większy kontrast kolorów między seriami).
- Benchmarki są przygotowywane po stronie serwera i przeliczane do waluty aktywnej zakładki (PLN/USD/EUR) z użyciem dziennych kursów FX (as-of, cache-first).
- Benchmark overlay jest ładowany leniwie po zaznaczeniu checkboxa i tylko dla wybranego benchmarku + aktywnego zakresu dat (API `/api/benchmarks/series`), aby nie spowalniać bazowego renderu dashboardu.
- Zakres 1D pokazuje widgety (zmiana dzienna / zwrot dzienny) zamiast pełnych wykresów.
- Zakres `ALL` czyta pełną historię snapshotów (bez limitu 730 dni).
- Zainwestowany kapitał liczymy jako kumulację: `net_external_cashflow + net_implicit_transfer`.
- Gdy flow snapshot ma luki (`null`), linia zainwestowanego kapitału przerywa się i nie domyślamy brakujących wartości.
- Holdings data from `get_portfolio_holdings` includes `instrument_type` for concentration warnings.
- Holdings with `instrument_type = CURRENCY` are valued at price 1.0 (no quotes); FX is only needed when base currency differs.
- PortfolioSwitcher handles selection only; creation happens in the dialog component.
- Portfolio selector UI (desktop `PortfolioSwitcher` + mobile `PortfolioMobileHeaderActions`) is shown only in aggregate view (`/portfolio`) and hidden in single-portfolio view (`/portfolio/<id>`).
- Single-portfolio view (`/portfolio/<id>`) exposes a prominent `Dodaj transakcję` CTA in the header; it opens intercepted `/transactions/new?portfolio=<id>` modal with forced portfolio selection.
- Aggregate and single-portfolio routes share one loading skeleton (`src/app/(app)/portfolio/PortfolioRouteLoading.tsx`) so switching portfolios displays immediate pending feedback.
- Onboarding route (`/onboarding`) reuses `CreatePortfolioDialog` through `CreateFirstPortfolioAction` to create the first portfolio and navigate to canonical `/portfolio/<id>`.
- Portfolio create flows (`sidebar`, `mobile header`, `onboarding`) navigate with `router.push` only; cache freshness relies on server-side `revalidateTag/revalidatePath` from portfolio write APIs instead of client `router.refresh()`.
- Legacy `/portfolio?portfolio=<id>` links are backward-compatible and redirected to canonical `/portfolio/<id>`.
- Nagłówek wykresu ma kompaktowy przełącznik waluty (PLN/USD/EUR) w jednym rzędzie z trybem i zakresem.
- Tryb performance eksponuje główną metrykę jako duży zwrot procentowy + mniejsza kwota bezwzględna za wybrany okres.
- Tryb wartości dla zakresów >1D eksponuje główną metrykę `Zmiana za okres` (kwota + procent) nad wykresem wartości/zainwestowanego kapitału.
- Dla historii z jednym punktem domyślny zakres wykresu to `ALL` (zamiast disabled `YTD`), a `Zmiana za okres` pozostaje pusta (`—`) do czasu pojawienia się co najmniej 2 punktów.
- Nagłówek wykresu pokazuje też komunikat o skróconej historii, gdy dane są chwilowo obcięte i pełny zakres `ALL` nie jest jeszcze dociągnięty.
- Tabela `Pozycje` używa nagłówków kolumn z walutą bazową i pokazuje liczby bez powtarzania symbolu waluty w każdym wierszu.
- Tabela `Pozycje` pokazuje też `Śr. cena zakupu` (weighted average buy cost) liczona po transakcjach `ASSET`; wartość jest przeliczana do waluty bazowej tym samym FX co wycena.
- Dashboard aggregate view wraps portfolio selector in a dedicated control surface (subtle bordered card) to separate filters from data widgets.
- Dashboard shows `Top movers` as compact read-only pills (max 4 rows) using normalized daily quote deltas converted to base currency; each pill also shows current quote price in instrument currency.
- Dashboard renders `Ostatnie transakcje` below `Alokacja i pozycje`, reusing the transactions table view and fetching newest rows (`date_desc`) with portfolio scope.
- Portfolio page header adds small context eyebrow (`Dashboard`) and uses centered max-width layout for cleaner visual rhythm on large screens.
- Dashboard content starts with a dedicated net-value hero (`Portfel: ...` + `Wartość netto`) rendered from `summary.totalValueBase` in the selected portfolio base currency.
- Net-value hero and chart header expose valuation freshness badges (`Notowania z ...`, `Kurs FX z dnia ...`) using `summary/liveTotals.asOf`.
- Dashboard shows a dedicated partial-valuation warning banner when quotes/FX are missing, with explicit counts (`missingQuotes`, `missingFx`).
- Dashboard page and key sections now use subtle reveal animations (`AnimatedReveal`) and warmer card styling (`ChartCard surface="subtle"`) for polished entry and better hierarchy.
- Net value hero and allocation/holdings widget use stronger typographic rhythm (monospace net value, cleaner heading/label contrast, calmer warning tones) without changing valuation logic.
- Past-dated transactions mark a dirty range and trigger chunked snapshot rebuild (`portfolio_snapshot_rebuild_state`) so history/performance can be recomputed from the affected date.
- Portfolio valuation includes per-user custom instruments (`custom_instruments`) as synthetic holdings with deterministic pricing (compounded annual rate) so they participate in totals and snapshot history.
- Chunk rebuild now computes per-day snapshots in a range-batch pass (single batched read of transactions + preloaded daily price/FX series, then in-memory day loop), instead of query-heavy day-by-day RPC pipeline.
- Dashboard chart surfaces rebuild status and shows loading state while history is being recomputed.
- Dashboard server payload (`summary`, `snapshots`, `live totals`, `recent transactions`) now uses Cache Components private caching with tags (`portfolio:all`, `portfolio:<id>`), so reads are reused between navigations and writes can invalidate deterministically.
- Dashboard initial snapshot payload is bounded to 400 days for faster first render; selecting `ALL` lazily loads full history from `/api/portfolio-snapshots/rows` (auth + RLS).
- User portfolio list reads are centralized in `server/get-user-portfolios-private-cached.ts` (private cache tag `portfolio:all`) and reused by app shell + portfolio page.
- Rebuild status hook polls only while `queued/running`, uses server-guided `nextPollAfterMs` (fallback backoff 2s→5s→10s), retries stale `running` states (>90s), and exposes progress fields (`fromDate`, `toDate`, `processedUntil`) for UI progress.
- Rebuild status hook can be nudged from client events (`portfolio:snapshot-rebuild-triggered`) to re-fetch state immediately even from idle, so loader appears without hard refresh after transaction writes.
- Rebuild progress percent math is shared (`lib/rebuild-progress.ts`) between API and client hook to avoid drift in UI vs backend progress interpretation.
- Rebuild polling/backoff decisions are isolated in `dashboard/hooks/snapshot-rebuild-polling.ts` so hook side effects stay easier to read.
- Empty holdings state uses the same dashboard widgets as non-empty portfolios; rebuild loaders are rendered inside widgets based on snapshot rebuild status.
- Empty chart states include actionable CTAs for both flows:
  - `Dodaj pierwsze kupno` (`/transactions/new` scoped by portfolio),
  - `Dodaj depozyt gotówki` (`preset=cash-deposit`).
- While rebuild is busy (`queued/running`), value chart disables live endpoint override and stays snapshot-based so `Wartość` and `Zainwestowany kapitał` move in one pipeline.
- Rebuild loading state is rendered directly in chart area via `PortfolioSnapshotRebuildChartLoader` (cool-tone, chart-shaped skeleton), replacing the old top progress bar.
- Rebuild loading state is also shown in `Alokacja i pozycje` (same `queued/running` source, with percent + date range), so allocation/holdings does not look stale during rebuild.
- Rebuild status API also returns backend-computed `progressPercent` derived from (`fromDate`, `toDate`, `processedUntil`) so UI does not own progress math.
- Rebuild API `POST /api/portfolio-snapshots/rebuild` logs chunk lifecycle (`post-start`, `post-finish`, `post-error`) for operational debugging.
- Rebuild route (`/api/portfolio-snapshots/rebuild`) keeps handler thin and delegates parse/access/response-shaping helpers to `server/snapshots/rebuild-route-service.ts`.
- Snapshot bootstrap/rebuild APIs share auth/body/error helper primitives from `src/lib/http/route-handler.ts` to keep route handlers thin and consistent.
- Rebuild client hook is split by responsibility (`events`, `state polling`, `runner`) and orchestrated by `useSnapshotRebuild.ts` to reduce side-effect complexity.
- Rebuild POST now revalidates portfolio cache tags/paths (`portfolio:all`, `portfolio:<id>`, `/portfolio`, `/portfolio/<id>`) when chunks process data, so private cached dashboard reads stay fresh after snapshot recompute.
- Rebuild worker merges concurrent `dirty_from` updates at chunk finalize (prevents losing backdated writes that arrive during an active rebuild run).
- Rebuild worker is adaptive per request: one POST can process multiple internal chunks under a server time budget (`timeBudgetMs`) with per-chunk day cap (`maxDaysPerRun`), reducing end-to-end rebuild latency.
- Internal chunks in one run now share a single preloaded rebuild session (transactions + daily prices + daily FX loaded once, then reused in-memory across chunks), eliminating repeated DB/provider reads per chunk.
- Daily cache preload validates range coverage quality (start/end + max internal gap), so sparse cache fragments trigger provider refetch instead of creating long flat carry-forward segments.
- Portfolio value/performance chart compute is split into a dedicated view-model builder (`dashboard/lib/portfolio-value-over-time-view-model.ts`) so the widget component stays focused on orchestration and rendering.
- Portfolio chart remembers selected range in localStorage per scope (`ALL` vs `PORTFOLIO:<id>`) so users keep their preferred timeframe between visits.
- Dashboard visual surfaces (hero, switcher shell, allocation/rebuild cards, and skeletons) were normalized to the same rounded/border rhythm as shared primitives, with decorative shadows/gradients reduced for consistency.
- Desktop polish follow-up tightened dashboard control density (`PortfolioValueOverTimeHeader`) and route-loading shell width alignment (`max-w-[1560px]`) for more consistent large-screen rhythm.
- Allocation/holdings widget palette now uses differentiated ink accents plus patterned fills (hatch/dots/cross/grid) across donut + participation bars, improving category distinction without breaking editorial style.
- Portfolio net-value hero now uses explicit typography split (sans labels + mono value) and `Badge` `stamp` freshness chips (`Notowania z...`, `Kurs FX z dnia...`) with calmer metadata contrast.
- Portfolio hero/widget surfaces adopt shared light-theme depth token (`--surface-shadow`) for subtle paper-card lift without heavy decorative shadows.
- Freshness badges remain only in the net-value hero; value/performance chart header no longer duplicates `Notowania z...` / `Kurs FX...` metadata.
- Value comparison chart now renders as an area chart (thicker primary stroke + subtle gradient fill under `Wartość portfela`) to anchor trend perception.
- Allocation mode uses desktop side-by-side composition in one panel: donut on the left (~40% width), allocation progress bars on the right to reduce wasted vertical space.
- Allocation donut labels custom holdings by `name` (instead of raw `CUSTOM`) and merges slices below `4%` into `Pozostałe` to reduce micro-slice noise.
- Value/performance filter groups (`Tryb`, `Zakres`, `Waluta`) were visually simplified by removing extra outer containers; segmented controls carry the hierarchy.
- Performance mode chart now follows the same grounded treatment as value mode: primary cumulative-return curve rendered as area with subtle gradient fill and thicker stroke.
- Portfolio chart control groups (`Tryb`, `Zakres`, `Waluta`, allocation `Koło/Tabela`) now use shared `ToggleGroup` `ledger` variant for stronger active-state hierarchy and lower border noise.
- Allocation mode density was tightened for desktop scanning (`h-[420px]`, `lg:h-[500px]`, donut `250px`) while preserving side-by-side composition.
- Currency units in hero + allocation numeric labels are visually subordinated (smaller/muted unit token) so users scan core numeric values first.
- Hero eyebrow (`Wartość netto`) now follows strict ledger hierarchy (`text-xs uppercase tracked muted`), with the primary amount carrying dominant visual weight.
- Net-value hero value now animates with a rapid count-up (`0 -> target`, ~0.6s) plus subtle fade-in-up (`10px`) on mount, with reduced-motion fallback.
- Value and performance chart surfaces now run through a shared chart engine (`UnifiedPortfolioTrendChart`) to keep line weight, gradients, tooltip chrome, and axis behavior aligned between modes; performance primary area flips to loss tone when latest cumulative return is negative.
- Portfolio widget chart height is parent-driven (`SHARED_PORTFOLIO_CHART_HEIGHT` wrappers in mode content), while chart primitives render at `h-full` for consistent sizing behavior across modes.

## Tests
- `src/features/portfolio/components/DashboardEmptyState.test.tsx`
- `src/features/portfolio/components/CreatePortfolioDialog.test.tsx`
- `src/features/portfolio/server/list-portfolios.test.ts`
- `src/features/portfolio/server/create-portfolio.test.ts`
- `src/features/portfolio/server/valuation.test.ts`
- `src/features/portfolio/server/average-buy-price.test.ts`
- `src/features/portfolio/server/snapshots/compute-portfolio-snapshot.test.ts`
- `src/features/portfolio/dashboard/lib/twr.test.ts`
- `src/features/portfolio/dashboard/lib/chart-helpers.test.ts`
- `src/features/portfolio/dashboard/lib/portfolio-value-over-time-view-model.test.ts`
- `src/features/portfolio/dashboard/widgets/PortfolioSnapshotRebuildChartLoader.test.ts`
- `src/features/portfolio/dashboard/widgets/PortfolioValueModeContent.test.tsx`
- `src/features/portfolio/dashboard/widgets/PortfolioTopMoversWidget.test.tsx`
- `src/features/portfolio/dashboard/widgets/top-movers-utils.test.ts`
- `src/features/portfolio/dashboard/widgets/portfolio-value-over-time-chart-helpers.test.ts`
- `src/features/portfolio/dashboard/PortfolioNetValueHero.test.tsx`
- `src/features/portfolio/server/snapshots/get-portfolio-snapshot-rows.test.ts`
- `src/features/portfolio/server/snapshots/snapshot-rows-route-service.test.ts`
- `src/features/portfolio/lib/create-portfolio-schema.test.ts`
- `src/features/portfolio/lib/portfolio-url.test.ts`
- `src/features/portfolio/lib/snapshot-rebuild-events.test.ts`
- TODO: extend snapshot rebuild tests beyond pure merge helpers (session lifecycle + concurrent dirty update integration).
