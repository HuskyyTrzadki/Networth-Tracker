# Transactions Feature Notes
This file must be kept up to date by the LLM whenever this feature changes.

## Purpose
- Transaction add/import UI, list view, and supporting form helpers.
- Persistence, validation, and server-side services.
- Transactions always belong to a portfolio (user must create at least one portfolio).
- Transactions list supports portfolio filtering (All vs. single portfolio).
- Transactions are grouped by `group_id`, with legs labeled by `leg_role` and `leg_key`.
- Cash instruments are `provider=system`, `instrument_type=CURRENCY`, used for settlement and cashflows.
- Add-transaction dialog uses 3 top-level asset modes: `Rynek` (market search), `Gotówka`, and `Nierynkowe` (per-user manual assets).
- `Nierynkowe` supports multiple manual asset kinds and sends `customInstrument` to the write API (instead of provider-backed `instrument`).
- For `Rynek`, the UI no longer filters by stock/ETF/crypto tabs; the search is a single combobox (excluding cash currencies).

## Main entrypoints
- Dialog UI: `src/features/transactions/components/AddTransactionDialog.tsx`
- Dialog content/fields: `src/features/transactions/components/AddTransactionDialogContent.tsx`
- Dialog field sections:
  - `src/features/transactions/components/add-transaction/AddTransactionDialogFields.tsx`
  - `src/features/transactions/components/add-transaction/AddTransactionInstrumentSection.tsx`
  - `src/features/transactions/components/add-transaction/AddTransactionTradeFields.tsx`
  - `src/features/transactions/components/add-transaction/AddTransactionCustomTradeFields.tsx`
  - `src/features/transactions/components/add-transaction/AddTransactionSidebarSummary.tsx`
  - `src/features/transactions/components/add-transaction/form-derivations.ts`
- Instrument search UI: `src/features/transactions/components/InstrumentCombobox.tsx`
- Instrument logo: `src/features/transactions/components/InstrumentLogoImage.tsx`
- Routes: `src/features/transactions/components/AddTransactionDialogRoute.tsx`
- Edit routes:
  - `src/features/transactions/components/AddTransactionEditDialogRoute.tsx`
  - `src/features/transactions/components/AddTransactionEditDialogStandaloneRoute.tsx`
- List UI: `src/features/transactions/components/TransactionsTable.tsx`
- Filters UI: `src/features/transactions/components/TransactionsSearchToolbar.tsx`
- Pagination UI: `src/features/transactions/components/TransactionsPagination.tsx`
- Row actions menu: `src/features/transactions/components/TransactionsRowActions.tsx`
- Form schema: `src/features/transactions/lib/add-transaction-form-schema.ts`
- Decimal helpers: `src/lib/decimal.ts`
- Currency formatting: `src/lib/format-currency.ts`
- Client API: `src/features/transactions/client/create-transaction.ts`
- Client FX preview API: `src/features/transactions/client/get-fx-preview.ts`
- Client cash as-of API: `src/features/transactions/client/get-cash-balance-on-date.ts`
- Server service: `src/features/transactions/server/create-transaction.ts`
- Server edit service: `src/features/transactions/server/update-transaction.ts`
- Server edit preload:
  - `src/features/transactions/server/get-transaction-group.ts`
  - `src/features/transactions/server/get-transaction-edit-preset.ts`
  - `src/features/transactions/server/get-transaction-edit-dialog-data.ts`
- Server helpers (create transaction):
  - `src/features/transactions/server/create-transaction-context.ts`
  - `src/features/transactions/server/create-transaction-write.ts`
- Server guards: `src/features/transactions/server/transaction-guards.ts`
- Server intent mapping: `src/features/transactions/server/transaction-intent.ts`
- Server settlement logic: `src/features/transactions/server/settlement.ts`
- Cash balances helper: `src/features/transactions/server/get-cash-balances.ts`
- Asset balances helper: `src/features/transactions/server/get-asset-balances.ts`
- Server query: `src/features/transactions/server/list-transactions.ts`
- Server filters: `src/features/transactions/server/filters.ts`
- Server helper: `src/features/transactions/server/resolve-portfolio-selection.ts`
- API schema: `src/features/transactions/server/schema.ts`
- FX preview API: `src/app/api/transactions/fx-preview/route.ts`
- Cash balance as-of API: `src/app/api/transactions/cash-balance-on-date/route.ts`
- Transaction group API: `src/app/api/transactions/[transactionId]/route.ts`
- Trade date rules: `src/features/transactions/lib/trade-date.ts`
- Instrument search service: `src/features/transactions/server/search-instruments.ts`
- Instrument search internals:
  - `src/features/transactions/server/search/search-types.ts`
  - `src/features/transactions/server/search/search-utils.ts`
  - `src/features/transactions/server/search/search-normalize.ts`
  - `src/features/transactions/server/search/local-search.ts`
  - `src/features/transactions/server/search/yahoo-search.ts`
  - `src/features/transactions/server/search/merge-results.ts`
- Instrument search API: `src/app/api/instruments/search/route.ts`
- Historical price assist service: `src/features/transactions/server/get-instrument-price-on-date.ts`
- Historical price assist API: `src/app/api/instruments/price-on-date/route.ts`

## Boundaries
- UI should not depend on provider-specific market data shapes.
- Server logic lives under `src/features/transactions/server/*` and is called by `src/app/api/transactions/route.ts` and `src/app/api/transactions/[transactionId]/route.ts`.
  - Instrument search is served via `src/app/api/instruments/search/route.ts` and normalizes provider data before returning.
- Transactions and portfolios route handlers now share auth/body/error boilerplate via `src/lib/http/route-handler.ts` so handlers stay thin and consistent.
- Global instruments cache stores optional logo URL in `public.instruments.logo_url` for UI branding.
- Global instruments cache stores canonical Yahoo quoteType in `public.instruments.instrument_type` for allocation/grouping.
- Cash settlement uses FX cache at write-time; rate is stored on the cash leg for auditability.
- Cash settlement for `consumeCash=true` uses daily FX as-of `trade_date` (with previous-session carry-forward) so backdated writes stay historically correct.
- Create-transaction guards enforce no oversell (asset/cash withdrawals) and prevent negative cash after settlement as-of `trade_date`.
- Past-date transaction support uses a hard lower bound (`2023-12-01`) + upper bound `today` (UI + backend validation).
- Add-transaction form fetches Yahoo daily session data (on date/instrument change) to suggest price and show low/high range.
- Add-transaction async client requests use shared keyed resource hook (`use-keyed-async-resource`) to avoid duplicated stale-request/loading logic.
- Add-transaction modal exposes a calendar date picker field with lower bound from `getTradeDateLowerBound()` and upper bound set to `today`.
- Add-transaction modal follows a strict two-pane contract: left side is data entry (including `Notatka`/`Opis`), right side is a sticky financial receipt (`AddTransactionSidebarSummary`) that only shows impact math and transaction context.
- Add-transaction custom (`Nierynkowe`) asset type selection uses a compact `Select` (not icon grids), preserving modal density and consistent control grammar with portfolio/currency selectors.
- Add-transaction custom annual-rate input uses plain numeric entry with `%` suffix and no decorative icons.
- Add-transaction form blocks submit when entered price is outside fetched day-session range (low/high), with inline field error on `price`.
- Historical price assist warning now distinguishes same-day fallback from no-session fallback:
  - selected `today` (exchange timezone) + fallback to prior candle => "session may still be in progress / daily close not available yet"
  - other fallback cases (weekend/holiday/past no-session day) => "no session day"
- Historical price assist for `trade_date = today` now prefers fresh live/cache quote (`instrument_quotes_cache` + Yahoo fallback) over previous daily close; when live quote is used, day-range validation is skipped (`range=null`) to avoid false "price out of session range" errors against prior-session OHLC.
- Historical price assist now performs an exact-day weekday revalidation when fallback session is older than selected date (`marketDate < selectedDate`) to prevent stale-cache false positives (e.g., selected weekday reported as no-session despite existing candle).
- On writes with `trade_date <= today`, backend marks snapshot dirty range via `portfolio_snapshot_rebuild_state` (`PORTFOLIO` + `ALL`), so both same-day and past-dated changes use one rebuild flow.
- Edit flow keeps instrument and portfolio identity fixed in v1; only trade fields are editable (date/qty/price/fee/notes/cash settlement).
- For custom assets, edit also allows changing annual gain/loss percent (`customAnnualRatePct`), persisted atomically with group replace via `replace_transaction_group_with_custom_rate`.
- Edit persistence is atomic delete-and-recreate of one `group_id` via RPC (`replace_transaction_group`) after TypeScript normalization/guards.
- Edit dirty range uses `min(old_trade_date, new_trade_date)` before marking snapshot rebuild state, so moving a transaction forward in time still rebuilds from the original earlier date.
- Add-transaction modal uses a wider desktop layout with two-pane composition (main form + side summary/cash panel), plus explicit loading states for both historical price assist and submit action.
- Add-transaction modal shows live cash impact preview (`dostępne / zmiana / po transakcji`) with FX preview for mismatched currencies and inline insufficient-cash warning.
- Add-transaction modal also shows cash balance on selected trade date (API as-of lookup) alongside current balance, and uses the as-of value for projected post-trade cash.
- Same-day guidance in cash section clarifies operational ordering: when date is equal, add cash deposit first, then asset buy.
- Instrument upsert does not overwrite an existing `logo_url` unless a non-empty value is provided by the client.
- `InstrumentCombobox` supports reusable presentation overrides (`emptyLabel`, `queryPlaceholder`, `triggerClassName`) so other features can reuse search behavior without duplicating async logic.
- Yahoo search debug logs are disabled by default and can be enabled with `DEBUG_YAHOO_SEARCH=1` (non-production only).
- Add-transaction modal shows "Dostępne do sprzedaży (na teraz)" hints for selected sell instrument per portfolio.
- After successful save in the intercepted portfolio modal route, dialog closes immediately; empty-dashboard refresh/loader is handled by portfolio-side rebuild status UI.
- Non-portfolio routes still rely on rebuild kickoff + client event flow and do not force a generic full-page refresh.
- After successful save, modal also triggers rebuild run kickoff (`/api/portfolio-snapshots/rebuild`) + dispatches `portfolio:snapshot-rebuild-triggered` client events for `PORTFOLIO` and `ALL`, so rebuild status/loader starts immediately without manual refresh.
- Transactions list type filter (`Wszystkie/Kupno/Sprzedaż`) uses a segmented toggle control instead of dropdown for faster switching and better mobile ergonomics.
- Transactions table visually separates cash settlement legs from primary asset action rows inside each `group_id`, but renders as one continuous ledger list (no per-group rounded boxes/cards).
- Ledger row separator style is baked into the transactions row component (`TransactionsLedgerRow` in `TransactionsTable.tsx`) using subtle dashed top borders for scanability.
- Grouping avoids accent borders/boxes; hierarchy is communicated via child-row indentation + muted text on cash legs, with dashed separators only at group boundaries.
- Transactions page sections now use subtle reveal animations (`AnimatedReveal`) for smoother perceived navigation/loading.
- Transactions toolbar, table chrome, and add-transaction dialog were visually refreshed (warmer surfaces, clearer micro-typography, calmer badges, consistent button/control sizing) without changing transaction behavior.
- Refresh pass tightened consistency further: unified rounded container scale (`rounded-lg`/`rounded-md`), removed excess visual depth from modal/table surfaces, and aligned segmented/toggle controls with shared primitive states.
- Desktop-only follow-up refined route-shell alignment (`max-w-[1560px]`), header hierarchy on `/transactions`, and dense form/table typography in add-transaction combobox + live summary for better scanability on large screens.
- Transactions empty state is actionable: no-results state can clear the search filters, and default empty state provides direct CTA to open add-transaction flow.
- Transactions toolbar exposes explicit pending feedback (`Aktualizowanie listy...`) while URL/filter transitions are in flight.
- Transactions table enforces ledger typography split: ticker/date/quantity/price/value cells stay `font-mono tabular-nums`, while descriptive copy remains sans for readability.
- Group row separators use subtle dashed dividers to reinforce the printed-ledger visual rhythm between asset/cash legs.
- Financial columns (`Ilość`, `Cena`, `Wartość`) are strictly right-aligned to preserve decimal-column scanability with `tabular-nums`.
- Cash settlement legs render as visual children of the primary asset row (left indentation + muted tone), improving grouped-transaction hierarchy.
- Monetary cells split amount vs unit tokens so currency suffixes (e.g. `USD`, `zł`) are smaller/more muted than the numeric value.
- Modal receipt summary (`TransactionLiveSummary`) also splits amount/unit tokens and keeps all monetary rows right-aligned with `font-mono tabular-nums`.
- Transactions table rows use motion choreography: quick top-to-bottom stagger on mount, layout animation for insertion reflow, and a short “fresh stamp” highlight (`~0.5s`) on newly added rows.
- Add-transaction routes (`/transactions/new` standalone and intercepted modal) redirect to onboarding when user has no portfolios, avoiding dead-end messaging.
- Add-transaction route wrappers trigger `router.refresh()` on submit success before closing/navigation, so transactions list reflects newly saved rows immediately.
- Add-transaction close guard uses an in-app confirmation dialog (`Odrzucić niezapisane zmiany?`) instead of `window.confirm`, so behavior stays consistent with design-system modals.
- Transactions page server payload (list + portfolios for toolbar) uses Cache Components private caching with tags (`transactions:all`, `transactions:portfolio:<id>`, `portfolio:all`) so revisits/filter toggles are warm and transaction/portfolio writes can invalidate deterministically.
- Stock report chart overlays now consume authenticated `ASSET` transaction legs by instrument `provider_key` to render BUY/SELL markers (`/api/stocks/[providerKey]/trade-markers`).
- DB index migration `20260216120000_transactions_query_indexes.sql` aligns transaction query paths with list/trade-marker/snapshot range predicates.
- Save success UX includes global toast feedback with undo (`Cofnij` for 10s). Undo calls `DELETE /api/transactions/[transactionId]` and re-triggers snapshot rebuild events.
- Edit success UX reuses the same modal and rebuild trigger flow, with save CTA/text switched to edit mode.
- Row action `Edytuj` is shown only for `ASSET` legs and opens `/transactions/<transactionId>/edit` (standalone or intercepted modal).
- Add-transaction routes accept `preset=cash-deposit` and prefill cash instrument + deposit defaults for faster first cash funding flow.
- Search surfaces that use `InstrumentCombobox` can opt into global `/` focus shortcut via `listenForFocusShortcut`.
- `InstrumentLogoImage` routes remote logo URLs through shared app proxy (`/api/public/image`) to keep `next/image` optimization enabled without custom passthrough loaders.

## Tests
- Add tests next to validators and parsers as `*.test.ts`.
- Current tests include trade date validation in `src/features/transactions/lib/trade-date.test.ts`.
